---
title: 中学生でもわかるSELinux
date: 2019-05-26 21:47:26 +0900
---

中学生でもわかるSELinux
===

タイトル詐欺です。

SELinuxは、一般的に「わかりにくい」「とりあえず無効化する」ものとして扱われています。
ただ、しっかり理解して使うことで、使うべきではない言葉なので修正してくださいのツールになりますし、そもそもそこまで難しいものではありません。

サクッと理解しちゃいましょう。

# SELinuxの思想

従来のLinuxは、オーナー、グループ、その他で、ファイルに対する読み込み、書き込み、実行を管理していました。
これを、__任意アクセス制御、 Discretionary Access Control(DAC)__ と呼びます。

それに対して、SELinuxは、 __強制アクセス制御、Mandatory Access Control(MAC)__ と呼ばれます。

「ユーザーが実行プロセスに与える権限」（プロセスがユーザーから借りられる権限とも言えます）と、「この権限ではどのファイルにアクセスできるか」を管理します。

## より詳しく
Androidスマートフォンを持っているほうは、設定項目にある「ロケーション」「連絡先へのアクセス」「カメラへのアクセス」を想像するとわかりやすいです。

各アプリケーションに対して、 __実行ファイルがどんな権限を持つか__ 、もっと言えばSELinuxはAndroidと同じくホワイトリスト方式なので __実行ファイルが持てるのはどの権限"だけ"なのか__ を設定します。

その上で、 __権限ごとにアクセスできるファイル群__ を設定します。

また、__実行するユーザーによっても、実行ファイルにあげられる権限が異なる__ ので、それを制御します。

- じゃあ従来のファイル制御は無効化されるの？
    - Linux本来のDACは無効化されません。ユーザーとグループによってファイルのrwxが確認されたあとに、SELinuxの処理が入ります。つまり、SELinuxを有効化したところで今まで読み書きできなかったファイルには依然として読み書きできません

- 権限が設定されていないとどうなるの？
    - デフォルトでは権限はhome_bin_tやsystem_bin_tなどになります（後術）。つまり、SELinuxを有効にしても、Apacheやbind、chromiumなどのアプリケーションを除き、lsやcp、mvなど基本的なコマンドは全てにおいて実行権限を持ちます。
    つまり、SELinuxは特定のアプリケーションにのみ権限の概念を付与します

# 名称と概念

## ポリシー

ポリシーは、SELinuxの設定のファイルの名称です。
上で説明した権限に関する設定が含まれています。

SELinux公式が、Debian、Ubuntuなどに対応する大きなデフォルトポリシーを作っています。

なので、ポリシーを自分でかく必要は（あまり）ありません。

https://github.com/SELinuxProject/refpolicy

## SELinuxユーザー

Linuxのユーザーの概念とは別に、SELinux内にもユーザーの概念があります。
Linuxのユーザーと一対一にする必要はなく、一対多の関係が作れます。

つまり、別のLinuxユーザーが同じSELinuxユーザーになることがあります。
（一人のLinuxユーザーが2つ以上のSELinuxユーザーになることはありません）。

SELinuxユーザーは、ある程度デフォルトで用意されたものがあります。


|ユーザー|ロール|ドメイン|X Window System|suまたはsudo|ホームディレクトリーおよび /tmp (デフォルト）で実行|ネットワーキング
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|sysadm_u	|sysadm_r	|sysadm_t	|はい	|suおよびsudo	|はい	|はい
|staff_u	|staff_r	|staff_t	|はい	|sudoのみ	|はい	|はい
|user_u		|user_r		|user_t		|はい	|いいえ	|はい	|はい
|guest_u	|guest_r	|guest_t	|いいえ	|いいえ|	いいえ|	いいえ
|xguest_u	|xguest_r	|xguest_t	|はい	|いいえ	|いいえ	|Firefoxのみ

ほにゃらら_uと書いてあるのがSELinuxユーザー名です。SELinuxはユーザー名のあとに_uを、ロールのあとに_rを、ドメインのあとに_tをつける風習があります。

今はロールやドメインのことは説明してないので無視して大丈夫です。

各SELinuxユーザーごとに、おおまかにシステムに対してできることがわけられていることだげ気にしてください。

また、これ以外にも自分でSELinuxユーザーを作成してLinuxユーザーに割り当てることもできます。

SELiunxユーザーには、unconfined_uというユーザーがあります。これがデフォルトのSELinuxユーザーで、特に設定をしないと全Linuxユーザーはこれに割り当てられます。特に何も設定はありません。


ここで一番覚えてほしいのは、 __SELinuxユーザーとは、"ユーザーがどのロールになれるか"、をまとめた概念である__ ということです。

## ロール

先程一瞬出てきましたが、ロールについてです。
ロールは、冒頭で話した。

>また、__実行するユーザーによっても、実行ファイルにあげられる権限が異なる__ ので、それを制御します。

の話になります。

この文章はちょっと間違っています。ユーザーという単語が実は嘘で、正確にはこうです。

 __実行するSELinuxユーザーのロールによって、実行ファイルにあげられる権限が異なる__

これだけだとわかりにくいので細かく説明していきましょう。

ロールは、「ユーザーが実行ファイルに与えられる権限」をまとめたものです。

たとえば、sysadm_rというドメインは、/etc以下にあるファイルアクセスを許可する権限を持っています。

なので、 __sysadm_rと言うロールを持つSELinuxユーザーが、/etc以下にあるファイルのアクセス権限を持つ実行ファイルを実行したときに、その実行ファイルは/etc以下のファイルを読み書きできる__、ということになります。

これで、実行するユーザーと実行される実行ファイルの権限の組み合わせで、システムへのアクセスを制御できる、というSELinuxの思想を実現できていますね。

ちなみに、SELinuxユーザーは複数のロールを持つことができます。
また、「sudoによるロール昇格」という機能もあるので、後術します。

## ドメイン

ドメインは、実行ファイルに紐付けられます。
ドメインは「どのファイルにアクセスできるか」の権限をまとめたものです。

たとえば、

- hoge_tというドメインは、/home/user1/.config/hogeにアクセスできる
- /usr/bin/hoge1と/usr/bin/hoge2は起動するとhoge_tドメインで起動する
- hoge_rというロールは、hoge_tというドメインを起動できる
- 今自分のSELinuxユーザーはhoge_rになれる

を設定できます。


## コンテキスト

SELinuxには、コンテキストという概念があります。
これは、SELinuxユーザー、ロール、タイプをコロン区切りで表したものです。
`ls -Z`と打つことでコンテキストを確認できます。

ここがわかりにくいのですが、ファイルにつけられるコンテキストと、実行しているプロセスにつけられるコンテキストは別物です。

たとえば、`/opt/google/chrome/chrome`には`system_u:object_r:chromium_exec_t`というコンテキストがつけられますが、
起動したchromeのプロセスには`system_u:user_r:chromium_t`というコンテキストがつけられます。

つまり、権限を指定するときに指定するファイルコンテキストと、実行しているプロセスの動作を縛るコンテキストは別の概念です。

ファイルの場合、ロールの概念が存在しないのでobject_rが指定されます。

# 今回はChromiumの例を使って順に説明してみる

ユーザーがuser、SELinuxユーザーがsysadm_rだとします。
ユーザーが`/opt/google/chrome/chrome`を起動すると、SELinuxはこの実行ファイルのファイルコンテキストを確認します。


ファイルコンテキストは`system_u:object_r:chromium_exec_t`なので、ユーザーが`chromium_t`ドメインを起動する権限があるか確認し、`user_u:sysadm_r:chromium_t`コンテキストでChromiumを起動します。

実行されたchromium_tドメインは、主に以下の権限が設定されています。

- `chromium_renderer_t`なドメインで動くレンダラプロセスへのアクセス（procfs)
- `chromium_tmp_t`なファイルコンテキストを持つファイルへのrw
- `chromium_xdg_config_t`なファイルコンテキストを持つファイルへのrw
- システムに対する`corenet_tcp_connect_all_unreserved_ports`の権限
- etc


これ以外の振る舞いをchromium_tなプロセスがすると、システムコールが拒否されます。

# sudoによるロール昇格

自分のロールを、起動するたびにSELinuxに選ばせるのではなく、シェルアクセスをしている際に強制的に変えたい場合があります。
その場合、sudoコマンドでロール昇格をできます。
例： user_r→sysadm_r。

このため、SElinuxでのsudoは従来のsudoとは少し意味合いが異なります。

# まとめ

- コンテキストには、ファイルのコンテキストと実行プロセスのコンテキストがある
- ファイルのコンテキストは最後のタイプだけを、実行プロセスのコンテンツはロールとドメインを見ればいい
- ドメインによって弄れるファイルのコンテキストやsyscallが異なる
- ロールによって、起動できるドメインがことなる
- ユーザーによって、持てるロールが異なる
- sudoコマンドを使うことで、強制的に上位のロールへ権限昇格することができる

参考： https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index
