---
title: "Androidのシステム領域改変まわりを取り巻く現状"
date: 2019-11-17 00:55:00 +0900
---

Androidのシステム領域改変まわりを取り巻く現状
===

最近弄っている知見をまとめます。

# Android システム改変とは

定義が大まかですが、もっともシンプルな説明をすると「通常状態では変更できない領域のデータを変更する」ことになります。
一般ユーザ権限で書き込みできないパーティションを編集したり、本来無効化されている機能を有効化するなどを指します。

# これを読む前に知っておきたい前提知識

簡単に書きます。

- Android OSはLinux from ScratchベースのLinuxOS。
- オープンソースであるAndroid Open Source Projectが存在し、各スマホメーカーはこのOSをもとにクローズドに機能追加を行い、完成したOSをスマートフォンへ書き込む。
- Androidのアプリケーション(.apk)の中身は、Javaのclassファイル群(.dex)とその他リソースをzip圧縮したもの。
- AndroidのGUIやアイコン、画像などといったリソースを画面にどう配置するかのレイアウトは、xmlファイルにて定義されている。
- Androidは内部で、JVMのような仮想ランタイムマシン(Android Runtime/Dalvik VM)を用いてアプリケーションを動作させる
- Android内部は、SELinuxによって完全に管理されている。
  - 各アプリケーションや、OS内部のデーモンまで、細かく権限の設定が行われている
  - 勿論、本来自分が持っている以上の権限を下位のプロセスにわたせない。
  - 詳しくは https://blog.katio.net/page/selinux

- Android のパーティションは、役割ごとに細かく分離され、それぞれ異なるマウントフラグが設定されている。
- トラストチェーン（ディスクの攻撃態勢）について
  - Androidスマートフォン内部には、耐タンバー性のあるセキュリティチップが存在し、BIOS（のようなもの。ファームウェア）の署名が正しいベンダーのものか確認してから起動する。(secure boot)
  - BIOSは、ブートローダ(いわゆるパソコンで言うgrub)の署名が正しいか検証してから起動する。
  - スマートフォン内部のEMMC/UFS(記憶素子)は、起動時にブートローダーによってシステムに関連するパーティションのハッシュが取られ、改ざんを検知する。(dm-verify)
  - Linuxカーネルは、起動後にブートローダーが改ざんされていないかハッシュを取って改ざんを検知する。(irc)
    - つまり、ブートローダーとカーネルは相互に検証を行います。


# Root化について

最も古くからある改変方式です。root権限を使えるようにします。**本来一般ユーザーでは使えないアカウントであるrootで、アプリケーションを実行**し、(正確にはsu -cをアプリケーションから使えるようにする)システムのprocfsやOSのファイルを編集する手法です。

手法としては、arm向けにコンパイルされ、suidが立ち、所有ユーザーがrootであるような`su`バイナリをスマートフォン内部のどこかに設置します。

方法としては2つあり、
- 正当な方法でスマートフォンのsecure bootやハッシュ検知機能を無効化(bootloader unlockと呼ばれる)してファイルを置く方法
- カーネルやブートローダーの脆弱性を利用し、権限昇格する手法

の2つが存在します。

# Boot Loader Unlockについて

Androidスマートフォンは、一部を除き、Boot Loader Unlockと呼ばれる機能を備えています。
これは、起動時にrootfsやリカバリ領域、その他パーティションに改ざんがあっても気にせず起動する機能です。
Unlockを行うことで、保証対象外になりパーティションが一度工場出荷状態に戻り、その後自由にパーティション/ファイルシステムの内容を編集できます。

この行為は、たとえデータを暗号化しても、パスワード入力画面などを改ざんされる可能性があるため、セキュリティ上おすすめはできません。ですが、システム改変を行う唯一の方法です。

# リカバリ / twrp について

Androidには、リカバリ領域と呼ばれるパーティションがあり、そこに小型のLinuxとタッチパネル操作用のフロントエンドが含まれています。各スマートフォンによってまちまちですが、大概がユーザーデータの消去や工場出荷時への初期化が行えるのみです。  
そもそもRoot化するためのsuバイナリを設置したり、それ以外にも起動中に変更できないファイルを変更する手段として、それまではパソコンから行っていました。  

それをリカバリ領域から行いたい要望が生まれ、Androidスマートフォンのリカバリ領域用のOS（ファームウェア）が誕生しました。有名なファームウェアの一つに、Team Win Recovery Project（以下、twrp）があります。  
twrpは、Linuxカーネルにcoreutil(cp,mv,ls,sh)を追加し、またzipファイル形式で提供されるシェルスクリプトを実行することができます。  
このため、ユーザーはRoot化を行うために、Boot Loader Unlockを行い、twrpをリカバリ領域に書き込み、リカバリからzipファイルを適用するだけで、あとは中のシェルスクリプトがsuバイナリを設置してくれるようになりました。

# Xposedについて

Root化が普及して以降、システムの設定を自由に書き換えられるようになりました。その後、更に既存のアプリケーションを改変したい要望が生まれました。そこで誕生したのがXposedです。
Xposedは、Androidの仮想マシンであるART/Dalvikに介入し、「**特定のアプリケーションの関数を勝手に別のものに置き換える**」機能を有します。  
そのため、他アプリケーションの機能追加や制限が行えるようになりました。
また、Root化はただのroot権限でのコマンド実行でしたが、こちらはAndroidのシステムアプリケーションにも介入することができます。  
つまり、ナビゲーションバーやロック画面、通知、ランチャーの動作を、より多岐にわたって改変を行えるようになりました。

Xposedを利用し機能改変を行うパッケージをXposed モジュールと呼びます。  
Xposedには、Xposed Managerと呼ばれるGUIアプリケーションが含まれ、このフロントエンドから各Xposedモジュールの有効化を行います。

# Magiskについて

Root化(suバイナリの設置)やXposed(VMを関数オーバーライドできるように置換)が開発されていくにつれ、「改変したファイルの消去がめんどくさい」「ファイルをコピーするのが面倒くさい」といった意見がでてきました。

そのため生まれたのがMagiskと呼ばれる改変技術です。  
簡単に言えば、これは、Linuxのパッケージマネージャに似ており、zip形式のパッケージのファイルを自動的にOSの`/system`以下に展開するものです。
これにより、zipファイルをMagiskに読み込ませれば、あとは自動でシステムのファイルの変更、置き換えが行えます。

また、Magiskはその後、Magic Mountと呼ばれる仕組みを開発しました。これは、ただzipファイルをコピーするのではなく、zipファイルを展開して出てきたファイルをtmpfsのoverlayとして`/system`以下にマウントします。  
このため、実際のシステム領域はごくわずか(tmpfsのmountを行うためにちょっとだけ)で、様々なシステム領域の変更を行うことができます。  
各パッケージを取り除く際も楽で、そのパッケージをディレクトリごと削除すればそれで完了です。  
このおかげで、各パッケージごとの一時無効化なども可能になりました。

Magiskで読み込まれるパッケージは、一般的にMagiskモジュールと呼ばれます。

Magiskは、`su`バイナリを最初から提供でき、またXposedなどもMagiskモジュールとして導入できます。モジュールのインストールはスマートフォン単体で行えるため、改変のコストが大幅に下がりました。

# Custom Theme / Substratum / Andromedaについて

Xposedが誕生するにつれ、アプリケーションの関数を置き換えるのではなく、GUIの画像や色を置き換えたいというニーズが生まれました。  
つまり、アプリケーションのUIデザインをユーザー側から勝手に改変する行為です。

SonyのXperiaには、実は既にその機能が存在しました。Sony Runtime Resource Overlayと呼ばれ、通知やナビゲーションバーの色を変えるものです。
これは、Xposedのようにアプリケーションが動作するときに読み込む画像やGUIリソース用のxmlファイルをあとから動的に変更する仕組みです。  
Sony Runtime Resource Overlayは、Android 8からAndroid本体にマージされました。Custom Themeと呼ばれる機能です。  

しかし、もともとシステムの一部のアプリケーションにしか使われておらず、TwitterやGmailアプリなど、ユーザーがあとから入れたアプリケーションには使用できませんでした。また、xmlを改変するための「テーマ」は、最初からシステムに入っているものしか利用できませんでした。  

このCustom Themeを有効活用したい要求から生まれたのが、Substratum / Andromedaです。  
AndroidのCustom Themeは、システム領域のテーマファイルを書き込む必要があります。  
Substratumは、それをRoot権限で行うため、スマートフォンのみで実行することができます。Andromedaは、その領域をパソコンとAndroidを接続した際に使える開発者モードから変更するものです。こちらはRoot権限がいりませんが、アプリケーションやテーマの更新のたびに毎回パソコンに接続する必要があります。  
結局はどちらも同じことを可能にします。
SubstratumやAndromedaでは、「**特定のアプリケーションのUIや画像、色、アイコンなどのリソースの変更**」が行えます。
